<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario Cables Especiales</title>
    <style>
        table { border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #000; padding: 5px 10px; text-align: center; }
        th { background-color: #f0f0f0; }
    </style>
</head>
<body>
    <h1>Pedido de Cable Especial</h1>
    <form id="formCables">
        <label>Tipo de cable:
            <select name="tipoCable">
                <option value="A">Cable A</option>
                <option value="B">Cable B</option>
                <option value="C">Cable C</option>
            </select>
        </label>
        <br><br>

        <label>Capuchón:
            <select name="capuchon">
                <option value="capuchón rojo">Capuchón rojo</option>
                <option value="capuchón negro">Capuchón negro</option>
            </select>
        </label>
        <br><br>

        <label>Terminal:
            <select name="terminal">
                <option value="terminal tipo A">Terminal tipo A</option>
                <option value="terminal tipo B">Terminal tipo B</option>
            </select>
        </label>
        <br><br>

        <button type="button" id="btnEnviar">Generar Excel</button>
    </form>

    <div id="vistaPrevia"></div>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        // Diccionarios simples
        const traducciones = {
            cables: { "A": "CAB-A", "B": "CAB-B", "C": "CAB-C" },
            capuchones: { "capuchón rojo": "CAP-R", "capuchón negro": "CAP-N" },
            terminales: { "terminal tipo A": "TERM-A", "terminal tipo B": "TERM-B" }
        };

        // Reglas especiales de combinación
        const reglasCombinaciones = {
            "B|capuchón rojo|terminal tipo A": "COD-B-ROJO-A",
            "A|capuchón negro|terminal tipo B": "COD-A-NEGRO-B"
        };

        const btnEnviar = document.getElementById("btnEnviar");
        const form = document.getElementById("formCables");
        const vistaPreviaDiv = document.getElementById("vistaPrevia");

        btnEnviar.addEventListener("click", function() {
            // 1️⃣ Capturar datos del cliente
            const datosCliente = {
                tipoCable: form.elements["tipoCable"].value,
                capuchon: form.elements["capuchon"].value,
                terminal: form.elements["terminal"].value
            };

            // 2️⃣ Generar datos técnicos
            const clave = `${datosCliente.tipoCable}|${datosCliente.capuchon}|${datosCliente.terminal}`;
            const codigoEspecial = reglasCombinaciones[clave] || "SIN-REGLA";

            const datosTecnicos = {
                tipoCable: traducciones.cables[datosCliente.tipoCable] || datosCliente.tipoCable,
                capuchon: traducciones.capuchones[datosCliente.capuchon] || datosCliente.capuchon,
                terminal: traducciones.terminales[datosCliente.terminal] || datosCliente.terminal,
                codigoFinal: codigoEspecial
            };

            // 3️⃣ Crear objeto combinado para Excel y vista previa
            const datosCombinados = {
                // Datos cliente
                cliente_tipoCable: datosCliente.tipoCable,
                cliente_capuchon: datosCliente.capuchon,
                cliente_terminal: datosCliente.terminal,
                // Datos técnicos
                tecnico_tipoCable: datosTecnicos.tipoCable,
                tecnico_capuchon: datosTecnicos.capuchon,
                tecnico_terminal: datosTecnicos.terminal,
                tecnico_codigoFinal: datosTecnicos.codigoFinal
            };

            // 4️⃣ Mostrar vista previa en tabla
            mostrarVistaPrevia([datosCombinados]);

            // 5️⃣ Exportar Excel
            exportarExcel([datosCombinados], "pedido_completo.xlsx");
        });

        function mostrarVistaPrevia(datos) {
            let html = "<table><thead><tr>";
            // encabezados
            Object.keys(datos[0]).forEach(k => html += `<th>${k}</th>`);
            html += "</tr></thead><tbody>";
            // filas
            datos.forEach(fila => {
                html += "<tr>";
                Object.values(fila).forEach(val => html += `<td>${val}</td>`);
                html += "</tr>";
            });
            html += "</tbody></table>";
            vistaPreviaDiv.innerHTML = html;
        }

        function exportarExcel(datos, nombreArchivo) {
            const hoja = XLSX.utils.json_to_sheet(datos);
            const libro = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(libro, hoja, "Pedido");
            XLSX.writeFile(libro, nombreArchivo);
        }
    </script>
</body>
</html>
