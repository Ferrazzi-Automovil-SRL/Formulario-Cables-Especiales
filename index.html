<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:type" content="Formulario Cables Especiales">
    <meta name="copyright" content="Emanuel Morano Solé">
    <link rel="icon" href="./images/favicon/favicon 32x32.ico" sizes="32x32" type="image/x-icon">
    <link rel="icon" href="./images/favicon/favicon 16x16.ico" sizes="16x16" type="image/x-icon">
    <title>Ferrazzi - Formulario Cables Especiales</title>
    <style>
    body { font-family: Arial, sans-serif; background:#f7f7f7; color:#333; margin:0; padding:0;}
    .container { max-width:800px; margin:30px auto; background:#fff; padding:30px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1)}
    h1{font-size:26px;margin-bottom:10px;}
    p.desc{color:#555;margin-bottom:20px;}
    section{margin-bottom:25px;}
    label{font-weight:bold; display:block;margin-bottom:8px;margin-top: 14px;}
    input[type="text"],select,textarea,input[type="file"]{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;margin-top:5px;}
    .options{margin-top:8px;}
    .options label{font-weight:normal; display:block; margin-bottom:6px;}
    .required{color:red;margin-left:4px;}
    button{background:#FE5000;color:#fff;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;font-size:16px;}
    button:hover{background:#d84500;}
    .card-container{display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap;margin-top:20px;}
    .cards{display:flex;flex-direction:column;align-items:center;justify-content:center;border:1px solid #ccc;border-radius:8px;padding:10px;cursor:pointer;width:300px;text-align:center;box-sizing:border-box;}
    .cards input[type="radio"]{margin-bottom:8px;}
    .cards img{max-width:100%;height:auto;max-height:300px;margin-bottom:6px;}
    .banner-img{width:100%;height:auto;display:block;border-radius:8px;}
    /*ocultar submenu*/
    .hidden {display: none;}
    /*correccion input type text*/
    input[type="text"], select, textarea, input[type="file"] {width: 100%;padding: 10px;border: 1px solid #ccc;border-radius: 6px;margin-top: 5px;box-sizing: border-box; /* Esto asegura que el padding y el borde se incluyan en el 100% del ancho */}
    .submenu-container {margin-top: 20px;}
    .submenu-capuchon {margin-bottom: 15px;}
    .model-card.selected-card {border: 2px solid #FE5000; box-shadow: 0 0 10px rgba(254, 80, 0, 0.5);}
    @media (max-width: 800px) {
    .card-container img {width: 100%;}
    .container {margin-right: 30px;margin-left: 30px;}
    }
    </style>
</head>
<body>
    <div class="container">
        <!-- Banner superior -->
        <div class="banner">
            <img src="./images/1x/bannerFerrazzi.jpg" alt="Ferrazzi" class="banner-img">
        </div>
    </div>

    <div class="container">
        <h1>Ferrazzi - Formulario de Cables Especiales</h1>
        <p class="desc">
            La fabricación de cables especiales se hace en Línea Competición de 9mm, color naranja. 
            La demora del mismo es de 7 días hábiles.
        </p>
        <!-- Aclaracion como tomar medidas de los cables -->
        <label for="medidas">Cuando coloque la medida de los cables, por favor tener en cuenta que los cables se miden de capuchón a capuchón contemplando el largo total.
            <div class="card-container">
                <img src="./images/largoCables.png" alt="Largo de los cables">
            </div>
        </label>

        <form id="formCables">
            <!-- Distribuidor o bobinas -->
            <section>
                <label>El vehículo es con distribuidor o bobinas individuales? <span class="required">*</span></label>
                <div class="options">
                    <label><input type="radio" name="sistema" value="bobinas" required> Bobinas individuales</label>
                    <label><input type="radio" name="sistema" value="distribuidor"> Distribuidor</label>
                </div>
            </section>
            <!-- SUBMENÚ PARA DISTRIBUIDOR -->
            <section id="submenuDistribuidor" class="hidden">
                <h3>Opciones Distribuidor</h3>

                <label for="lado1_tipo">Tipo conexión Lado Distribuidor:</label>
                <select id="lado1_tipo" name="lado1_tipo">
                    <option value="">Elegir combinación...</option>
                    <option value="dist_90_pin">PIN 90°</option>
                    <option value="dist_180_pin">PIN 180°</option>
                    <option value="dist_90_din7">DIN 7mm Motorcraft 90°</option>    
                    <option value="dist_90_din8">DIN 8mm 90°</option>
                    <option value="dist_180_din8">DIN 8mm 180°</option>
                    <option value="dist_90_sae">SAE 90°</option>
                    <option value="dist_180_sae">SAE 180°</option>
                </select>

                <label for="lado2_tipo">Tipo conexión Lado Bobina:</label>
                <select id="lado2_tipo" name="lado2_tipo">
                    <option value="">Elegir combinación...</option>
                    <option value="gol_90_pin">PIN GOL 14mm 90°</option>
                    <option value="gol_180_pin">PIN GOL 14mm 180°</option>
                    <option value="corsa_90_pin">PIN CORSA 18mm 90°</option>
                    <option value="corsa_180_pin">PIN CORSA 18mm 180°</option>
                    <option value="onix_120_pin">PIN ONIX 120°</option>
                    <option value="zetec_90_pin">PIN ZETEC 90°</option>
                    <option value="Motorcraft_90_din7">DIN 7mm (Motorcraft) 90°</option>
                    <option value="falcon_90_din8">DIN 8mm (Falcon/128) 90°</option>
                    <option value="falcon_180_din8">DIN 8mm (Falcon/128) 180°</option>
                    <option value="uni_90_sae">SAE 90°</option>
                    <option value="uni_180_sae">SAE 180°</option>
                    <!-- <option value="DIS">SAE</option> -->
                </select>

                <label for="largo_cable">Largo del Cable (cm):</label>
                <input type="text" id="largo_cable" name="largo_cable" placeholder="Ej: 30">
            </section>

            <!-- Cantidad cilindros -->
            <section>
                <label for="cilindros">Indicar la cantidad de cilindros <span class="required">*</span></label>
                <select id="cilindros" name="cilindros" required>
                    <option value="">Elegir...</option>
                    <option>4</option>
                    <option>6</option>
                    <option>8</option>
                </select>
            </section>
            <section id="largosCilindros" class="hidden">
                <label>Largo de cables por cilindro (cm):</label>
                <div id="inputsLargos"></div>
            </section>

            <!-- Capuchones lado bujías -->
            <section>
                <label>Tipo de Capuchones, lado Bujías <span class="required">*</span></label>
                
                <div class="options">
                    <label><input type="radio" name="metodo_seleccion_bujia" value="visual" required> Selección Visual</label>
                    <label><input type="radio" name="metodo_seleccion_bujia" value="codigo" required> Ingresar Código de Catálogo</label>
                </div>

                <div id="visual-selection-container" class="hidden">
                    <label style="margin-top:20px;">Paso 1: Seleccione una categoría</label>
                    <div class="options card-container">
                        <label class="cards"><img src="./images/1x/RECTO_BUJIA.jpg" alt="RECTO"><span>Recto</span><input type="radio" name="cap_bujia_categoria" value="recto" data-single-model="true" data-model-value="CF22"  ></label>
                        <label class="cards"><img src="./images/1x/A90_BUJIA.jpg" alt="A 90"><span>A 90°</span><input type="radio" name="cap_bujia_categoria" value="90"></label>
                        <label class="cards"><img src="./images/1x/RECTO_TIPOCORSA.jpg" alt="TIPO CORSA"><span>Recto, tipo Corsa</span><input type="radio" name="cap_bujia_categoria" value="corsa" data-single-model="true" data-model-value="Corsa Classic"> </label>
                        <label class="cards"><img src="./images/1x/ANGULO_BUJIA.jpg" alt="EN ANGULO"><span>En ángulo</span><input type="radio" name="cap_bujia_categoria" value="angulo"></label>
                    </div>

                    <div id="submenus-capuchones" class="submenu-container">
                        <div id="submenu-recto" class="submenu-capuchon hidden">
                            <label>Paso 2: Seleccione el modelo</label>
                            <div class="options card-container">
                                <label class="cards model-card"><img src="./images/1x/RECTO_BUJIA.jpg" alt="CF22"><span>CF22</span><input type="radio" name="cap_bujia_modelo_final" value="CF22"></label>
                                
                            </div>
                        </div>
                        <div id="submenu-90" class="submenu-capuchon hidden">
                            <label>Paso 2: Seleccione el modelo</label>
                            <div class="options card-container">
                                <label class="cards model-card"><img src="./images/1x/CF19.jpg" alt="Modelo X"><span>CF19</span><input type="radio" name="cap_bujia_modelo_final" value="CF19"></label>
                                <label class="cards model-card"><img src="./images/1x/CF24.jpg" alt="Modelo X"><span>CF24</span><input type="radio" name="cap_bujia_modelo_final" value="CF24"></label>
                                <label class="cards model-card"><img src="./images/1x/CF230.jpg" alt="Modelo X"><span>CF230</span><input type="radio" name="cap_bujia_modelo_final" value="CF230"></label>
                            </div>
                        </div>
                        <div id="submenu-corsa" class="submenu-capuchon hidden">
                            <label>Paso 2: Seleccione el modelo</label>
                            <div class="options card-container">
                                <label class="cards model-card"><img src="./images/modelos/corsa_classic.jpg" alt="Corsa Classic"><span>Corsa Classic</span><input type="radio" name="cap_bujia_modelo_final" value="Corsa Classic"></label>
                            </div>
                        </div>
                        <div id="submenu-angulo" class="submenu-capuchon hidden">
                            <label>Paso 2: Seleccione el modelo</label>
                            <div class="options card-container">
                                <label class="cards model-card"><img src="./images/1x/CF15.jpg" alt="Angulo 45 CF15"><span>CF15</span><input type="radio" name="cap_bujia_modelo_final" value="CF15"></label>
                                <label class="cards model-card"><img src="./images/1x/CF39.jpg" alt="Angulo 45 CF39"><span>CF39</span><input type="radio" name="cap_bujia_modelo_final" value="CF39"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="codigo-selection-container" class="hidden">
                    <label for="clase_producto_bujia" style="margin-top:20px;">Ingrese la Clase de Producto del catálogo:</label>
                    <input type="text" id="clase_producto_bujia" name="clase_producto_bujia" placeholder="Ej: A02-96">
                </div>
            </section>

            <!-- Nueva seccion que contempla Terminales y capuchones de las bobinas y del distribuidor segun lo que elija el user mas arriba -->
            <section id="config-bobina-section" class="hidden">
                <label for="combo_bobina">Configuración Lado Bobina <span class="required">*</span></label>
                <select id="combo_bobina" name="combo_bobina">
                    <option value="">Elegir combinación...</option>
                    <option value="gol_90_pin">PIN GOL 14mm 90°</option>
                    <option value="gol_180_pin">PIN GOL 14mm 180°</option>
                    <option value="corsa_90_pin">PIN CORSA 18mm 90°</option>
                    <option value="corsa_180_pin">PIN CORSA 18mm 180°</option>
                    <option value="onix_120_pin">PIN ONIX 120°</option>
                    <option value="zetec_90_pin">PIN ZETEC 90°</option>
                    <option value="Motorcraft_90_din7">DIN 7mm (Motorcraft) 90°</option>
                    <option value="falcon_90_din8">DIN 8mm (Falcon/128) 90°</option>
                    <option value="falcon_180_din8">DIN 8mm (Falcon/128) 180°</option>
                    <option value="uni_90_sae">SAE 90°</option>
                    <option value="uni_180_sae">SAE 180°</option>
                </select>
            </section>

            <section id="config-distribuidor-section" class="hidden">
                <label for="combo_distribuidor">Configuración Lado Distribuidor <span class="required">*</span></label>
                <select id="combo_distribuidor" name="combo_distribuidor">
                    <option value="">Elegir combinación...</option>
                    <option value="dist_90_pin">PIN 90°</option>
                    <option value="dist_180_pin">PIN 180°</option>
                    <option value="dist_90_din7">DIN 7mm Motorcraft 90°</option>    
                    <option value="dist_90_din8">DIN 8mm 90°</option>
                    <option value="dist_180_din8">DIN 8mm 180°</option>
                    <option value="dist_90_sae">SAE 90°</option>
                    <option value="dist_180_sae">SAE 180°</option>
                </select>
            </section>

            <!-- Nota final -->
            <section>
                <label for="nota">¿Tenés algo que quieras agregar sobre tu pedido? Escribilo acá ⚡</label>
                <input type="text" id="nota" name="nota" placeholder="Escribí tu comentario...">
            </section>

            <button type="submit">Exportar a excel</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    <script>
        // --- LÓGICA DE VISIBILIDAD DEL FORMULARIO ---

        // 1. Lógica para Sistema (Bobina vs Distribuidor)
        const sistemaRadios = document.querySelectorAll('input[name="sistema"]');
        const submenuDistribuidor = document.getElementById("submenuDistribuidor");
        const seccionConfigBobina = document.getElementById('config-bobina-section');
        const seccionConfigDistribuidor = document.getElementById('config-distribuidor-section');
        const selectBobina = document.getElementById('combo_bobina');
        const selectDistribuidor = document.getElementById('combo_distribuidor');

        sistemaRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                if (radio.value === "bobinas" && radio.checked) {
                    seccionConfigBobina.classList.remove("hidden");
                    selectBobina.required = true;
                    submenuDistribuidor.classList.add("hidden");
                    seccionConfigDistribuidor.classList.add("hidden");
                    selectDistribuidor.required = false;
                } else if (radio.value === "distribuidor" && radio.checked) {
                    submenuDistribuidor.classList.remove("hidden");
                    seccionConfigDistribuidor.classList.remove("hidden");
                    selectDistribuidor.required = true;
                    seccionConfigBobina.classList.add("hidden");
                    selectBobina.required = false;
                }
            });
        });

        // 2. Lógica para Cilindros
        const cilindrosSelect = document.getElementById("cilindros");
        const largosCilindros = document.getElementById("largosCilindros");
        const inputsLargos = document.getElementById("inputsLargos");

        cilindrosSelect.addEventListener("change", () => {
            const cantidad = parseInt(cilindrosSelect.value);
            inputsLargos.innerHTML = "";
            if (!isNaN(cantidad)) {
                largosCilindros.classList.remove("hidden");
                for (let i = 1; i <= cantidad; i++) {
                    const div = document.createElement("div");
                    div.style.marginBottom = "6px";
                    div.innerHTML = `<label>Cilindro ${i}:</label><input type="text" name="largo_cil_${i}" placeholder="Ej: 30" required>`;
                    inputsLargos.appendChild(div);
                }
            } else {
                largosCilindros.classList.add("hidden");
            }
        });

        // 3. Lógica para Selección de Capuchones de Bujía (Método, Categoría y Modelo)
        
        // 3. Lógica para Selección de Capuchones de Bujía (Método, Categoría y Modelo)
    const radiosMetodoBujia = document.querySelectorAll('input[name="metodo_seleccion_bujia"]');
    const containerVisual = document.getElementById('visual-selection-container');
    const containerCodigo = document.getElementById('codigo-selection-container');
    const inputCodigo = document.getElementById('clase_producto_bujia');
    const radiosCategoriaVisual = document.querySelectorAll('input[name="cap_bujia_categoria"]');
    const todosLosSubmenusDeModelos = document.querySelectorAll('.submenu-capuchon');
    const cardsModeloVisual = document.querySelectorAll('.model-card');
    const radiosModeloFinal = document.querySelectorAll('input[name="cap_bujia_modelo_final"]');
    const form = document.getElementById('formCables'); // Referencia al formulario

    // Lógica para elegir el MÉTODO
    radiosMetodoBujia.forEach(radio => {
        radio.addEventListener('change', () => {
             // Resetear radios de categoría y modelo al cambiar de método
            radiosCategoriaVisual.forEach(r => r.checked = false);
            radiosModeloFinal.forEach(r => r.checked = false);
            todosLosSubmenusDeModelos.forEach(submenu => submenu.classList.add('hidden'));
            cardsModeloVisual.forEach(c => c.classList.remove('selected-card'));
            
            if (radio.value === 'visual') {
                containerVisual.classList.remove('hidden');
                containerCodigo.classList.add('hidden');
                inputCodigo.required = false;
                radiosCategoriaVisual.forEach(r => r.required = true); // Hacer categorías requeridas
            } else if (radio.value === 'codigo') {
                containerCodigo.classList.remove('hidden');
                containerVisual.classList.add('hidden');
                inputCodigo.required = true;
                radiosCategoriaVisual.forEach(r => r.required = false); // Quitar required de categorías
                radiosModeloFinal.forEach(r => r.required = false); // Quitar required de modelos
            }
        });
    });

    // Lógica para la SELECCIÓN VISUAL (Categorías y Modelos)
    radiosCategoriaVisual.forEach(radioCategoria => {
        radioCategoria.addEventListener('change', (event) => {
            const categoriaSeleccionadaElement = event.target;
            const esModeloUnico = categoriaSeleccionadaElement.dataset.singleModel === 'true';
            const categoriaValue = categoriaSeleccionadaElement.value;

            // Siempre: Ocultar todas las sub-galerías y resetear modelos
            todosLosSubmenusDeModelos.forEach(submenu => submenu.classList.add('hidden'));
            radiosModeloFinal.forEach(r => {
                r.required = false;
                r.checked = false;
            });
            cardsModeloVisual.forEach(c => c.classList.remove('selected-card'));

            if (esModeloUnico) {
                // --- CASO MODELO ÚNICO ---
                const modeloUnicoValue = categoriaSeleccionadaElement.dataset.modelValue;
                const radioModeloUnico = form.querySelector(`input[name="cap_bujia_modelo_final"][value="${modeloUnicoValue}"]`);

                if (radioModeloUnico) {
                    radioModeloUnico.checked = true; // Selecciona el radio del modelo
                    radioModeloUnico.required = true; // Lo hace obligatorio
                    
                    // Añadir borde visual a la tarjeta de CATEGORÍA (no a la del modelo oculto)
                     const cardCategoria = categoriaSeleccionadaElement.closest('.cards');
                     if(cardCategoria){
                         // Quitar borde de otras categorías antes de poner el nuevo
                         document.querySelectorAll('input[name="cap_bujia_categoria"]').forEach(rc => {
                             const cardC = rc.closest('.cards');
                             if (cardC) cardC.classList.remove('selected-card'); // Usar la misma clase
                         });
                         cardCategoria.classList.add('selected-card'); // Poner borde a la categoría
                     }

                } else {
                    console.error("No se encontró el radio button para el modelo único:", modeloUnicoValue);
                }
                // No mostramos submenú (Paso 2)

            } else {
                 // --- CASO MÚLTIPLES MODELOS ---
                 // Quitar borde de selección de las categorías si se elige una múltiple
                 document.querySelectorAll('input[name="cap_bujia_categoria"]').forEach(rc => {
                     const cardC = rc.closest('.cards');
                     if (cardC) cardC.classList.remove('selected-card');
                 });

                const submenuAMostrar = document.getElementById(`submenu-${categoriaValue}`);
                if (submenuAMostrar) {
                    submenuAMostrar.classList.remove('hidden');
                    // Hacer obligatorios solo los modelos DENTRO del submenú visible
                    submenuAMostrar.querySelectorAll('input[name="cap_bujia_modelo_final"]').forEach(r => r.required = true);
                }
            }
        });
    });

    // Lógica para el BORDE de selección en las tarjetas de MODELO
    cardsModeloVisual.forEach(card => {
        card.addEventListener('click', () => {
            cardsModeloVisual.forEach(c => c.classList.remove('selected-card'));
            card.classList.add('selected-card');
            // Asegurarse de que el radio dentro de la card clickeada esté seleccionado
            const radioInside = card.querySelector('input[type="radio"]');
            if (radioInside) {
                radioInside.checked = true;
                // Disparar evento change manualmente si es necesario para alguna lógica
                 // radioInside.dispatchEvent(new Event('change', { bubbles: true })); 
            }
        });
    });

        // --- DICCIONARIOS DE CÓDIGOS ---
        //Opcion visual
        const codigosCapuchonBujia = {
            "CF22": { capuchon: "CF22", terminal: "T96" },
            "CF15": { capuchon: "CF15", terminal: "T9" },
            "CF39": { capuchon: "CF39", terminal: "T96" },
            "CF05": { capuchon: "CF05", terminal: "T06" },
            "CF19": { capuchon: "CF19", terminal: "T05" },
            "CF24": { capuchon: "CF24", terminal: "T05" },
            "CF230": { capuchon: "CF230", terminal: "T22" },
            "Corsa Classic": { capuchon: "CF216", terminal: "T216" }, // deberia funcionar
            // ...Ponemos los capuchones y terminales que responden a las referencias visuales
        };
        /////////////////////////////
        //Opcion codigo
        const codigosPorClaseProducto = {
            "A02-96": { capuchon: "C216", terminal: "T216" },
            // ...Ponemos clase de productos, cada una refiere a un capuchón y terminal.
        };
        /////////////////////////////
        //Combinaciones bobina y distribuidor
        const datosBobinaCombinados = {
            "gol_90_pin": { capuchon: "CF74", terminal: "T22" },
            "gol_180_pin": { capuchon: "CF23", terminal: "T35" },
            "corsa_90_pin": { capuchon: "CF18", terminal: "T15" },
            "corsa_180_pin": { capuchon: "CF57", terminal: "T35" },
            "onix_120_pin": { capuchon: "CF144", terminal: "T35" },
            "zetec_90_pin": { capuchon: "CF77", terminal: "T77" },
            "falcon_90_din8": { capuchon: "CF74", terminal: "T10" },
            "falcon_180_din8": { capuchon: "CF27", terminal: "T92" },
            "motorcraft_90_din7": { capuchon: "CF20", terminal: "T7" },
            "uni_90_sae": { capuchon: "CF17", terminal: "T5" },
            "uni_180_sae": { capuchon: "CF62", terminal: "T96" },
            // Aca ponemos todas las combinaciones de bobina
        };
        const datosDistribuidorCombinados = {
            "dist_90_pin": { capuchon: "CF74", terminal: "T22" },
            "dist_180_pin": { capuchon: "CF23", terminal: "T35" },
            "dist_90_din7": { capuchon: "CF20", terminal: "T7" },
            "dist_90_din8": { capuchon: "CF74", terminal: "T10" },
            "dist_180_din8": { capuchon: "CF27", terminal: "T92" },
            "dist_90_sae": { capuchon: "CF17", terminal: "T5" },
            "dist_180_sae": { capuchon: "CF62", terminal: "T96" },
            // ponemos las combinaciones de distribuidor
        };
        //////////////////////////////////////////
        //Cable de distribuidor
        //lado1
        const codigosCableDistLado1 = {
            "dist_90_pin":  { capuchon: "CF74", terminal: "T22" },
            "dist_180_pin": { capuchon: "CF23", terminal: "T35" },
            "dist_90_din7": { capuchon: "CF20", terminal: "T7" },
            "dist_90_din8": { capuchon: "CF74", terminal: "T10" },
            "dist_180_din8":{ capuchon: "CF27", terminal: "T92" },
            "dist_90_sae":  { capuchon: "CF17", terminal: "T5" },
            "dist_180_sae": { capuchon: "CF62", terminal: "T96" }
        // Las claves deben coincidir con los 'value' del select 'lado1_tipo'
        };
        //lado2
        const codigosCableDistLado2 = {
        "gol_90_pin": { capuchon: "CF74", terminal: "T22" },
            "gol_180_pin": { capuchon: "CF23", terminal: "T35" },
            "corsa_90_pin": { capuchon: "CF18", terminal: "T15" },
            "corsa_180_pin": { capuchon: "CF57", terminal: "T35" },
            "onix_120_pin": { capuchon: "CF144", terminal: "T35" },
            "zetec_90_pin": { capuchon: "CF77", terminal: "T77" },
            "falcon_90_din8": { capuchon: "CF74", terminal: "T10" },
            "falcon_180_din8": { capuchon: "CF27", terminal: "T92" },
            "motorcraft_90_din7": { capuchon: "CF20", terminal: "T7" },
            "uni_90_sae": { capuchon: "CF17", terminal: "T5" },
            "uni_180_sae": { capuchon: "CF62", terminal: "T96" },
        };
        //////////////////////////////////////////


        // --- LÓGICA DE EXPORTACIÓN AL ENVIAR EL FORMULARIO ---
        document.getElementById("formCables").addEventListener("submit", async function(e){
            e.preventDefault();
            const form = e.target;

            // Función para obtener los datos del lado Bujía (visual o por código)
            const getDatosBujia = () => {
                const metodoSeleccionado = form.querySelector('input[name="metodo_seleccion_bujia"]:checked');
                if (!metodoSeleccionado) return { datosTecnicos: {}, valorCliente: "" };

                if (metodoSeleccionado.value === 'codigo') {
                    const codigoClase = form.clase_producto_bujia.value.trim().toUpperCase();
                    return { datosTecnicos: codigosPorClaseProducto[codigoClase] || {}, valorCliente: codigoClase };
                }
                if (metodoSeleccionado.value === 'visual') {
                    const modeloVisual = form.querySelector('input[name="cap_bujia_modelo_final"]:checked');
                    if (modeloVisual) {
                        const nombreModelo = modeloVisual.value;
                        return { datosTecnicos: codigosCapuchonBujia[nombreModelo] || {}, valorCliente: nombreModelo };
                    }
                }
                return { datosTecnicos: {}, valorCliente: "" };
            };

            // 1. Capturar todos los datos del formulario
            const largosArray = Array.from({ length: parseInt(form.cilindros.value) || 0 }, (_, i) => form[`largo_cil_${i + 1}`]?.value || "");
            const seleccionBujia = getDatosBujia();
            const sistema = form.sistema.value;

            let capuchonLadoMotor = "", terminalLadoMotor = "", descripcionLadoMotor = "";
            
            if (sistema === 'bobinas') {
                const combo = form.combo_bobina;
                const datosCombo = datosBobinaCombinados[combo.value] || {};
                capuchonLadoMotor = datosCombo.capuchon;
                terminalLadoMotor = datosCombo.terminal;
                descripcionLadoMotor = combo.options[combo.selectedIndex]?.text;
            } else if (sistema === 'distribuidor') {
                const combo = form.combo_distribuidor;
                const datosCombo = datosDistribuidorCombinados[combo.value] || {};
                capuchonLadoMotor = datosCombo.capuchon;
                terminalLadoMotor = datosCombo.terminal;
                descripcionLadoMotor = combo.options[combo.selectedIndex]?.text;
            }

            // 2. Organizar datos para las filas del Excel
            const datosCliente = {
                cilindros: form.cilindros.value,
                sistema: sistema,
                cap_bujia: seleccionBujia.valorCliente, // Valor visual o código de clase
                configuracion_lado_motor: descripcionLadoMotor, // Descripción bobina o distribuidor combo
                nota: form.nota.value,
                // Datos específicos del cable de distribuidor (si aplica)
                distribuidor_lado1_desc: (sistema === 'distribuidor' && form.lado1_tipo.selectedIndex > 0) ? form.lado1_tipo.options[form.lado1_tipo.selectedIndex].text : "",
                distribuidor_lado2_desc: (sistema === 'distribuidor' && form.lado2_tipo.selectedIndex > 0) ? form.lado2_tipo.options[form.lado2_tipo.selectedIndex].text : "",
                distribuidor_largo_cable_cm: (sistema === 'distribuidor') ? form.largo_cable.value : ""
            };

            // Buscar códigos técnicos para el cable del distribuidor
            const datosDistLado1 = (sistema === 'distribuidor') ? codigosCableDistLado1[form.lado1_tipo.value] || {} : {};
            const datosDistLado2 = (sistema === 'distribuidor') ? codigosCableDistLado2[form.lado2_tipo.value] || {} : {};
            
            // Largo técnico del cable del distribuidor (sin cálculo)
            let largoCableDistTecnico = "";
            if (sistema === 'distribuidor' && datosCliente.distribuidor_largo_cable_cm) {
                largoCableDistTecnico = datosCliente.distribuidor_largo_cable_cm; // Usar el valor original
            }

            const datosTecnicos = {
                // Bujía (sin cambios)
                terminal_bujia: seleccionBujia.datosTecnicos.terminal || "N/A",
                cap_bujia: seleccionBujia.datosTecnicos.capuchon || seleccionBujia.valorCliente,
                // Lado Motor (bobina o distribuidor combo - sin cambios)
                terminal_bobina: terminalLadoMotor || "N/A",
                cap_bobina: capuchonLadoMotor || "N/A",
                // Datos técnicos específicos del CABLE de distribuidor
                cable_dist_term1: datosDistLado1.terminal || "N/A",
                cable_dist_cap1:  datosDistLado1.capuchon || "N/A",
                cable_dist_term2: datosDistLado2.terminal || "N/A",
                cable_dist_cap2:  datosDistLado2.capuchon || "N/A",
                cable_dist_largo_tec: largoCableDistTecnico
            };
            
            // 3. Generar la lista de artículos
            const articulos = largosArray.map(largo => {
                if (!largo) return "";
                // Usamos los códigos técnicos generales (bobina/dist combo) para los cables de cilindro
                const terminales = `${datosTecnicos.terminal_bujia}-${datosTecnicos.terminal_bobina}`;
                const capuchones = `${datosTecnicos.cap_bujia}-${datosTecnicos.cap_bobina}`;
                return `${largo} cm, ${terminales}/${capuchones}`;
            });

            // NUEVO: Añadir el cable del distribuidor a la lista si aplica
            let esCableDistribuidor = false; // Variable para marcar si el último ítem es el cable especial
            if (sistema === 'distribuidor' && datosCliente.distribuidor_largo_cable_cm) {
                const largoDist = datosCliente.distribuidor_largo_cable_cm;
                // Usamos los códigos técnicos específicos del CABLE del distribuidor
                const terminalesDist = `${datosTecnicos.cable_dist_term1}-${datosTecnicos.cable_dist_term2}`;
                const capuchonesDist = `${datosTecnicos.cable_dist_cap1}-${datosTecnicos.cable_dist_cap2}`;
                const descripcionCableDistribuidor = `${largoDist} cm, ${terminalesDist}/${capuchonesDist} (Cable Distribuidor)`;
                articulos.push(descripcionCableDistribuidor); // Lo agregamos al final
                esCableDistribuidor = true; // Marcamos que el último ítem es este cable
            }

            // 4. Crear y llenar el archivo Excel
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet("Pedido");
            // --- INICIO: Agregar Fila de Título Principal ---
            const titleRow = sheet.addRow(['Cables Especiales']);
            // Fusiona celdas (ajusta la 'G' si tienes más o menos columnas fijas antes de los largos)
            sheet.mergeCells('A1:G1'); 
            const titleCell = sheet.getCell('A1');
            titleCell.font = { size: 16, bold: true };
            titleCell.alignment = { vertical: 'middle', horizontal: 'center' };
            sheet.getRow(1).height = 30; // Aumentar altura de la fila del título

            // Añadir una fila vacía para separar
            sheet.addRow([]); 
            // --- FIN: Agregar Fila de Título Principal ---
            
            // Fila de Encabezados (AJUSTADA PARA COMBINAR)
            const headers = ["Cilindros", "Sistema", ...largosArray.map((_, i) => `Largo Cilindro ${i + 1}`)];
            
            if (sistema === 'distribuidor') {
                // Encabezados para el CABLE del distribuidor (mostrando datos del cliente)
                headers.push(
                    "Cable Distribuidor: Lado Distribuidor", // Descripción Lado 1 (Cliente)
                    "Cable Distribuidor: Lado Bobina",      // Descripción Lado 2 (Cliente)
                    "Cable Distribuidor: Largo (cm)"        // Largo CM (Cliente)
                );
            }
            
            // Encabezados generales (para Cliente Y Técnico)
            headers.push(
                "Lado Bujía",             // Combinará descripción (Cliente) o códigos Cap/Term (Técnico)
                "Lado Motor",             // Combinará descripción (Cliente) o códigos Cap/Term (Técnico)
                "Nota"                    // Nota (Solo Cliente)
            );
            sheet.addRow(headers);

            // Fila Cliente
            const filaClienteData = [datosCliente.cilindros, datosCliente.sistema, ...largosArray];
            if (sistema === 'distribuidor') {
                filaClienteData.push(
                datosCliente.distribuidor_lado1_desc,
                datosCliente.distribuidor_lado2_desc,
                datosCliente.distribuidor_largo_cable_cm
                );
            }
            filaClienteData.push(datosCliente.cap_bujia, datosCliente.configuracion_lado_motor, datosCliente.nota);
            sheet.addRow(filaClienteData).eachCell(cell => cell.alignment = { wrapText: true, vertical: 'middle', horizontal: 'center' });

            // Fila Técnica (COMBINANDO CÓDIGOS)
            const largosTecnicos = largosArray; // Largos originales
            const filaTecnicaData = [datosCliente.cilindros, datosCliente.sistema, ...largosTecnicos];

            // Combinar códigos técnicos en strings
            const ladoBujiaTec = `${datosTecnicos.cap_bujia} / ${datosTecnicos.terminal_bujia}`;
            const ladoMotorTec = `${datosTecnicos.cap_bobina} / ${datosTecnicos.terminal_bobina}`;

            // Añadir datos TÉCNICOS específicos según el sistema elegido
            if (sistema === 'distribuidor') {
                // Si es DISTRIBUIDOR, añadimos los datos combinados del CABLE
                const cableLado1Tec = `${datosTecnicos.cable_dist_cap1} / ${datosTecnicos.cable_dist_term1}`;
                const cableLado2Tec = `${datosTecnicos.cable_dist_cap2} / ${datosTecnicos.cable_dist_term2}`;
                
                filaTecnicaData.push(
                    cableLado1Tec,                      // Lado 1 del Cable (Cap/Term)
                    cableLado2Tec,                      // Lado 2 del Cable (Cap/Term)
                    datosTecnicos.cable_dist_largo_tec  // Largo técnico del Cable
                );
            }
            
            // Añadir SIEMPRE los datos técnicos COMBINADOS generales
            filaTecnicaData.push(
                ladoBujiaTec,   // Lado Bujía (Cap/Term)
                ladoMotorTec    // Lado Motor (Cap/Term)
                // La nota no se agrega a la fila técnica
            );

            // Aplicar estilo a la Fila Técnica
            sheet.addRow(filaTecnicaData).eachCell(cell => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFA500' } };
                cell.alignment = { wrapText: true, vertical: 'middle', horizontal: 'center' };
            });

            // Tabla de Artículos en D12
            const filaInicioArticulos = 9; // <--- AGREGAR ESTA LÍNEA
            const columnaArticulos = 'D';   // <--- AGREGAR ESTA LÍNEA
            const headerCell = sheet.getCell(`${columnaArticulos}${filaInicioArticulos}`);
            headerCell.value = 'Articulo';
            headerCell.font = { bold: true };
            // Recorrer la lista de artículos (incluyendo el posible cable de distribuidor)
            articulos.forEach((articulo, index) => {
                const filaActual = filaInicioArticulos + 1 + index;
                const celdaArticulo = sheet.getCell(`${columnaArticulos}${filaActual}`);
                celdaArticulo.value = articulo;
                celdaArticulo.alignment = { wrapText: true, vertical: 'middle' };

                // NUEVO: Aplicar fondo celeste si es el cable del distribuidor
                // Verificamos si es el último índice Y si marcamos que se agregó el cable
                if (esCableDistribuidor && index === articulos.length - 1) {
                    celdaArticulo.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFADD8E6' } // Celeste claro (LightBlue)
                    };
                }
            });
            // --- Añadir Bordes a las Tablas ---
            // Borde para la tabla principal (Filas 1 a 3)
            for (let i = 1; i <= 3; i++) { // Asumiendo 3 filas: Encabezado, Cliente, Técnica
                const row = sheet.getRow(i);
                row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                    // Solo aplica borde hasta la última columna con encabezado
                    if (colNumber <= headers.length) { 
                        cell.border = {
                            top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' }
                        };
                    }
                });
            }

            // Borde para la tabla de Artículos (D9 hacia abajo) - CORREGIDO
            const ultimaFilaArticulos = filaInicioArticulos + articulos.length; // Calcula la última fila
            for (let i = filaInicioArticulos; i <= ultimaFilaArticulos; i++) { // Empieza desde filaInicioArticulos (9)
                const cell = sheet.getCell(`D${i}`);
                cell.border = {
                    top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' }
                };
            }
            // --- Fin Bordes ---
            // 5. Descargar el archivo
            // Ajustar ancho de columnas
            sheet.columns.forEach(column => {
                let maxLen = 0;
                column.eachCell({ includeEmpty: true }, cell => {
                    let len = cell.value ? cell.value.toString().length : 0;
                    if (cell.value && typeof cell.value === 'string' && cell.value.includes('\n')) {
                    // Si hay saltos de línea, considera la línea más larga
                    len = Math.max(...cell.value.split('\n').map(line => line.length));
                    }
                    if (len > maxLen) {
                        maxLen = len;
                    }
                });
                // Añade un poco de padding y limita el ancho máximo
                column.width = Math.min(Math.max(maxLen, 10) + 2, 50); 
            });
            // Ajuste especial para la columna de Artículos (D) si existe
            const colArticulo = sheet.getColumn('D');
            if (colArticulo) colArticulo.width = 40; // Dale un ancho fijo más grande
            const buf = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buf], { type: "application/octet-stream" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "pedido_completo.xlsx";
            a.click();
            URL.revokeObjectURL(a.href);
        });
    </script>


</body>
</html>
